# SBOM & Security Scan for {{ cookiecutter.project_name }}
# Software Bill of Materials generation and vulnerability scanning
#
# Generates CycloneDX SBOMs and scans with Trivy for vulnerabilities
# Documentation: https://cyclonedx.org/

{%- if cookiecutter.include_github_actions == "yes" %}
name: SBOM & Security Scan

on:
  pull_request:
    paths:
      - "pyproject.toml"
      - "uv.lock"
      - ".github/workflows/sbom.yml"
  push:
    branches:
      - main
      - master
      - develop
    paths:
      - "pyproject.toml"
      - "uv.lock"
  schedule:
    # Weekly scan every Monday at 8:00 AM UTC
    - cron: "0 8 * * 1"
  workflow_dispatch:

permissions: read-all

jobs:
  generate-sbom:
    name: Generate SBOMs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: "{{ cookiecutter.python_version }}"

      - name: Install UV
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install cyclonedx-bom
        run: pip install cyclonedx-bom==4.6.1

      - name: Install dependencies
        run: uv sync --frozen

      - name: Generate runtime SBOM (production dependencies)
        run: |
          cyclonedx-py environment \
            --of json \
            -o sbom-runtime.json \
            .venv

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: sboms
          path: sbom-*.json
          retention-days: 90

  scan-runtime:
    name: Scan Runtime Dependencies
    needs: generate-sbom
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write  # Required for SARIF upload
    steps:
      - name: Download SBOM artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: sboms

      - name: Trivy SBOM scan (runtime)
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.33.1
        with:
          scan-type: sbom
          scan-ref: sbom-runtime.json
          format: table
          severity: CRITICAL,HIGH
          exit-code: 1  # Fail on CRITICAL/HIGH vulnerabilities

      - name: Trivy SBOM scan (runtime - detailed report)
        if: always()
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.33.1
        with:
          scan-type: sbom
          scan-ref: sbom-runtime.json
          format: sarif
          output: trivy-runtime-results.sarif

      - name: Upload Trivy results to GitHub Security tab
        if: always()
        uses: github/codeql-action/upload-sarif@48ab28a6f5dbc2a99bf1e0131198dd8f1df78169 # v3.27.5
        with:
          sarif_file: trivy-runtime-results.sarif
          category: trivy-runtime-deps

  license-compliance:
    name: License Compliance Check
    needs: generate-sbom
    runs-on: ubuntu-latest
    steps:
      - name: Download SBOM artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: sboms

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: "{{ cookiecutter.python_version }}"

      - name: Check licenses in runtime SBOM
        run: |
          echo "Checking runtime dependency licenses..."
          python -c "
          import json
          with open('sbom-runtime.json') as f:
              sbom = json.load(f)

          # Use precise SPDX license identifiers (exact match)
          forbidden_licenses = [
              'GPL-2.0-only', 'GPL-2.0-or-later',
              'GPL-3.0-only', 'GPL-3.0-or-later',
              'AGPL-3.0-only', 'AGPL-3.0-or-later'
          ]
          issues = []

          for component in sbom.get('components', []):
              licenses = component.get('licenses', [])
              for lic in licenses:
                  lic_id = lic.get('license', {}).get('id', '')
                  if lic_id in forbidden_licenses:
                      issues.append(f\"{component['name']}: {lic_id}\")

          if issues:
              print('WARNING: Found potentially incompatible licenses:')
              for issue in issues:
                  print(f'  - {issue}')
              # Don't fail, just warn
          else:
              print('All licenses compatible')
          "
{%- else %}
# GitHub Actions disabled for this project
# Enable include_github_actions to use SBOM generation and security scanning
{%- endif %}
