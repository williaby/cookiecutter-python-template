# PR Validation for {{ cookiecutter.project_name }}
# Comprehensive pull request validation using org-level workflow plus additional checks.
#
# This workflow calls the org-level PR validation workflow and adds supplementary
# checks for dead code detection, changelog enforcement, and documentation links.
{%- if cookiecutter.include_github_actions == "yes" %}
name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - master
      - develop

# Cancel in-progress runs for same PR
concurrency:
  group: {% raw %}pr-validation-${{ github.event.pull_request.number }}{% endraw %}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  # ==========================================================================
  # Org-Level PR Validation (Core Checks)
  # ==========================================================================
  core-validation:
    name: Core Validation
    uses: {{ cookiecutter.github_org_or_user }}/.github/.github/workflows/python-pr-validation.yml@main
    with:
      python-version: '{{ cookiecutter.python_version }}'
      source-directory: 'src'
      test-directory: 'tests'
      require-tests: true
      require-conventional-commits: true
      require-description: true
      min-description-length: 50
      check-breaking-changes: true
      add-size-labels: true
      coverage-threshold: {{ cookiecutter.code_coverage_target }}
    secrets: inherit

  # ==========================================================================
  # Additional Checks (Template-Specific)
  # ==========================================================================

  # Dead Code Detection with Vulture
  dead-code:
    name: Dead Code Check
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: "{{ cookiecutter.python_version }}"

      - name: Install UV
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run vulture
        run: |
          echo "## Dead Code Report" >> $GITHUB_STEP_SUMMARY
          uv run vulture src/ --min-confidence 90 | tee vulture-report.txt || true
          if [ -s vulture-report.txt ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat vulture-report.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "::warning::Potential dead code detected. Review vulture report."
          else
            echo "✅ No dead code detected with 90% confidence." >> $GITHUB_STEP_SUMMARY
          fi

  # Changelog Enforcement
  changelog:
    name: Changelog Check
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Check for CHANGELOG update
        uses: dangoslen/changelog-enforcer@v3
        with:
          changeLogPath: 'CHANGELOG.md'
          skipLabels: 'skip-changelog,dependencies,documentation'
          missingUpdateErrorMessage: |
            Please update CHANGELOG.md with a description of your changes.
            Add the label 'skip-changelog' if this PR doesn't require a changelog entry.

{% if cookiecutter.use_mkdocs == "yes" %}
  # Documentation Link Check
  link-check:
    name: Documentation Links
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Check documentation links
        uses: lycheeverse/lychee-action@v1
        with:
          args: >-
            --verbose
            --no-progress
            --accept 200,204,206,301,302,403,429
            --exclude-mail
            --exclude '^https://github.com/.*/(issues|pulls|compare)/.*$'
            --exclude '^https://linear.app/.*$'
            './docs/**/*.md'
            './README.md'
            './CONTRIBUTING.md'
          fail: false
          jobSummary: true
        env:
          GITHUB_TOKEN: {% raw %}${{ secrets.GITHUB_TOKEN }}{% endraw %}
{% endif %}

  # ==========================================================================
  # Validation Summary
  # ==========================================================================
  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [core-validation, dead-code, changelog{% if cookiecutter.use_mkdocs == "yes" %}, link-check{% endif %}]
    if: always()
    steps:
      - name: Check validation results
        run: |
          echo "## PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          {% raw %}
          if [ "${{ needs.core-validation.result }}" == "success" ]; then
            echo "✅ Core Validation: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Core Validation: ${{ needs.core-validation.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.dead-code.result }}" == "success" ]; then
            echo "✅ Dead Code Check: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Dead Code Check: ${{ needs.dead-code.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.changelog.result }}" == "success" ]; then
            echo "✅ Changelog: Updated" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.changelog.result }}" == "skipped" ]; then
            echo "⏭️ Changelog: Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Changelog: ${{ needs.changelog.result }}" >> $GITHUB_STEP_SUMMARY
          fi
          {% endraw %}

          {% if cookiecutter.use_mkdocs == "yes" %}
          {% raw %}
          if [ "${{ needs.link-check.result }}" == "success" ]; then
            echo "✅ Link Check: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Link Check: ${{ needs.link-check.result }}" >> $GITHUB_STEP_SUMMARY
          fi
          {% endraw %}
          {% endif %}

          {% raw %}
          # Fail if core validation failed
          if [ "${{ needs.core-validation.result }}" == "failure" ]; then
            echo ""
            echo "❌ Core validation checks failed. Please review and fix issues." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          {% endraw %}

          echo ""
          echo "✅ All validation checks passed!" >> $GITHUB_STEP_SUMMARY
{%- else %}
# PR Validation workflow - NOT CONFIGURED
# To enable this workflow, set include_github_actions to "yes" in cookiecutter.json
{%- endif %}
