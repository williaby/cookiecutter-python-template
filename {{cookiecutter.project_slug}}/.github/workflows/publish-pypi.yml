# {% raw %}{{ cookiecutter.project_name }}{% endraw %} - PyPI Publishing Workflow
# Publishes to PyPI using Trusted Publishing (OIDC)
#
# Setup Instructions:
# 1. Go to https://pypi.org/manage/account/publishing/
# 2. Add a new publisher:
#    - PyPI Project Name: {% raw %}{{ cookiecutter.pypi_package_name }}{% endraw %}
#    - Owner: {% raw %}{{ cookiecutter.github_org_or_user }}{% endraw %}
#    - Repository: {% raw %}{{ cookiecutter.project_slug }}{% endraw %}
#    - Workflow: publish-pypi.yml
# 3. Create a release tag (v*.*.*)
#
# For TestPyPI setup:
# 1. Go to https://test.pypi.org/manage/account/publishing/
# 2. Follow same steps as above

name: Publish to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      use_testpypi:
        description: 'Publish to TestPyPI instead of PyPI'
        required: false
        default: true
        type: boolean

permissions: read-all

jobs:
  build:
    name: Build Distribution Packages
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Harden the runner (Audit outbound calls)
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Set up Python {% raw %}{{ cookiecutter.python_version }}{% endraw %}
        uses: actions/setup-python@8d9ed9ac5c53483de85588cdf95a591a75ab9f55 # v5.5.0
        with:
          python-version: '{% raw %}{{ cookiecutter.python_version }}{% endraw %}'

      - name: Install Poetry
        uses: snok/install-poetry@76e04a911780d5b312d89783f7b1cd627778900a # v1.4.1
        with:
          version: 2.1.2
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Build distribution packages
        run: |
          poetry build
          echo "ðŸ“¦ Built packages:"
          ls -lh dist/

      - name: Verify package metadata
        run: |
          pip install twine==6.2.0
          twine check dist/*

      - name: Upload distribution artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: python-package-distributions
          path: dist/
          retention-days: 5
          if-no-files-found: error

  publish-to-pypi:
    name: Publish to PyPI
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && !inputs.use_testpypi)
    needs: [build]
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read
      id-token: write  # Required for Trusted Publishing (OIDC)

    steps:
      - name: Harden the runner (Audit outbound calls)
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
        with:
          egress-policy: audit

      - name: Download distribution artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: python-package-distributions
          path: dist/

      - name: Verify artifacts
        run: |
          echo "ðŸ“¦ Packages to publish:"
          ls -lh dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e # v1.13.0
        with:
          print-hash: true
          verbose: true

      - name: Publication summary
        run: |
          echo "## ðŸŽ‰ Published to PyPI!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Project**: https://pypi.org/project/{% raw %}{{ cookiecutter.pypi_package_name }}{% endraw %}/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Install**: \`pip install {% raw %}{{ cookiecutter.pypi_package_name }}{% endraw %}\`" >> $GITHUB_STEP_SUMMARY

  publish-to-testpypi:
    name: Publish to TestPyPI
    if: github.event_name == 'workflow_dispatch' && inputs.use_testpypi
    needs: [build]
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read
      id-token: write  # Required for Trusted Publishing (OIDC)

    steps:
      - name: Harden the runner (Audit outbound calls)
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
        with:
          egress-policy: audit

      - name: Download distribution artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: python-package-distributions
          path: dist/

      - name: Verify artifacts
        run: |
          echo "ðŸ“¦ Test packages to publish:"
          ls -lh dist/

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e # v1.13.0
        with:
          repository-url: https://test.pypi.org/legacy/
          print-hash: true
          verbose: true

      - name: Publication summary
        run: |
          echo "## ðŸ§ª Published to TestPyPI!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          URL="https://test.pypi.org/project/{% raw %}{{ cookiecutter.pypi_package_name }}{% endraw %}/"
          echo "**Project**: ${URL}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          INSTALL_CMD="pip install --index-url https://test.pypi.org/simple/"
          INSTALL_CMD="${INSTALL_CMD} {% raw %}{{ cookiecutter.pypi_package_name }}{% endraw %}"
          echo "**Test Install**: \`${INSTALL_CMD}\`" >> $GITHUB_STEP_SUMMARY
