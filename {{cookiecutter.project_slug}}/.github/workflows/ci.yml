# {% raw %}{{ cookiecutter.project_name }}{% endraw %} - CI Pipeline
# Main CI workflow with UV dependency management and comprehensive testing
#
# CI FOCUS: Code Quality & Testing
# This workflow focuses on code quality, formatting, and comprehensive testing.
# Security scanning has been consolidated in security-analysis.yml workflow.
#
# QUALITY CHECKS (This Workflow):
#   - {% if cookiecutter.use_mypy == "yes" %}MyPy: Strict type checking{% endif %}
#   - {% if cookiecutter.use_ruff == "yes" %}Ruff: Enhanced linting and formatting{% endif %}
#   - Type Hints: Validates | union syntax has future annotations
#   - Pytest: Comprehensive test suite with {{ cookiecutter.code_coverage_target }}%+ coverage
#
# SECURITY SCANS (See security-analysis.yml):
#   - {% if cookiecutter.include_security_scanning == "yes" %}Bandit: Python static security analysis{% endif %}
#   - {% if cookiecutter.include_security_scanning == "yes" %}Safety: Python dependency CVE scanning{% endif %}
#   - {% if cookiecutter.include_security_scanning == "yes" %}CodeQL: Advanced security analysis{% endif %}
#
# This separation improves CI performance by ~10-12 minutes per PR

name: CI

on:
  workflow_dispatch:  # Manual trigger for testing
  pull_request:
    branches:
      - main
      - develop
      - 'feature/**'
  push:
    branches:
      - main
      - develop

permissions:
  contents: read        # For checkout
  pull-requests: write  # For PR comments
  checks: write         # For check runs

concurrency:
  group: ci-{% raw %}${{  github.ref  }}{% endraw %}
  cancel-in-progress: true

env:
  CI_ENVIRONMENT: true
  UV_CACHE_DIR: ~/.cache/uv
  {% if cookiecutter.use_mypy == "yes" %}MYPY_CACHE_DIR: ~/.cache/mypy{% endif %}

jobs:
  # Setup and dependency caching
  setup-optimized:
    name: Setup with UV Caching
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      uv-hash: {% raw %}${{  steps.cache-key.outputs.uv-hash  }}{% endraw %}
      pyproject-hash: {% raw %}${{  steps.cache-key.outputs.pyproject-hash  }}{% endraw %}
    steps:
      - name: Harden the runner (Audit outbound calls)
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Generate cache keys
        id: cache-key
        run: |
          echo "uv-hash={% raw %}${{  hashFiles('**/uv.lock')  }}{% endraw %}" >> $GITHUB_OUTPUT
          echo "pyproject-hash={% raw %}${{  hashFiles('**/pyproject.toml')  }}{% endraw %}" >> $GITHUB_OUTPUT

      - name: Set up Python {% raw %}{{ cookiecutter.python_version }}{% endraw %}
        uses: actions/setup-python@8d9ed9ac5c53483de85588cdf95a591a75ab9f55 # v5.5.0
        with:
          python-version: '{% raw %}{{ cookiecutter.python_version }}{% endraw %}'

      - name: Install UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      # Optimized caching strategy
      - name: Cache UV dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            .venv
            ~/.cache/uv
          key: py-deps-{% raw %}${{  runner.os  }}{% endraw %}-{% raw %}${{  steps.cache-key.outputs.uv-hash  }}{% endraw %}
          restore-keys: |
            py-deps-{% raw %}${{  runner.os  }}{% endraw %}-

      - name: Install dependencies
        run: |
          uv sync --no-interaction --all-extras

      - name: Dependency validation
        run: |
          echo "üîç Validating core dependencies..."
          uv run python -c "
          import sys
          required_deps = ['pydantic', 'structlog']
          print('‚úÖ Core Dependencies:')
          for dep in required_deps:
              try:
                  mod = __import__(dep)
                  version = getattr(mod, '__version__', 'unknown')
                  print(f'  ‚úÖ {dep} ({version}): OK')
              except ImportError as e:
                  print(f'  ‚ùå {dep}: FAILED - {e}')
                  sys.exit(1)
          print('‚úÖ All core dependencies validated')
          "

      - name: Clean up disk space
        run: |
          echo "üßπ Cleaning up disk space..."
          uv cache clean 2>/dev/null || true
          sudo apt-get clean 2>/dev/null || true
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc 2>/dev/null || true

  # Comprehensive testing
  test:
    name: Test Suite (Python {% raw %}${{  matrix.python-version  }}{% endraw %})
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: setup-optimized
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13", "3.14"]
      fail-fast: false

    steps:
      - name: Harden the runner (Audit outbound calls)
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python {% raw %}${{  matrix.python-version  }}{% endraw %}
        uses: actions/setup-python@8d9ed9ac5c53483de85588cdf95a591a75ab9f55 # v5.5.0
        with:
          python-version: {% raw %}${{  matrix.python-version  }}{% endraw %}

      - name: Install UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Restore dependency cache
        uses: actions/cache/restore@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            .venv
            ~/.cache/uv
          key: py-deps-{% raw %}${{  runner.os  }}{% endraw %}-{% raw %}${{  needs.setup-optimized.outputs.uv-hash  }}{% endraw %}
          restore-keys: |
            py-deps-{% raw %}${{  runner.os  }}{% endraw %}-

      - name: Install dependencies
        run: |
          uv sync --no-interaction --all-extras

      # Run comprehensive test suite
      - name: Run test suite
        run: |
          echo "üß™ Running test suite..."
          uv run pytest -v \
            --cov=src \
            --cov-report=xml:coverage.xml \
            --cov-report=term-missing \
            --cov-report=html:htmlcov \
            --cov-fail-under={{ cookiecutter.code_coverage_target }} \
            --junitxml=junit.xml \
            -o junit_family=xunit2 \
            --tb=short \
            --maxfail=10 \
            tests/
        env:
          CI_ENVIRONMENT: true

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: test-results-{% raw %}${{  matrix.python-version  }}{% endraw %}
          path: |
            junit.xml
            coverage.xml
            htmlcov/

  # Quality checks
  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 12
    needs: setup-optimized
    steps:
      - name: Harden the runner (Audit outbound calls)
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python {% raw %}{{ cookiecutter.python_version }}{% endraw %}
        uses: actions/setup-python@8d9ed9ac5c53483de85588cdf95a591a75ab9f55 # v5.5.0
        with:
          python-version: '{% raw %}{{ cookiecutter.python_version }}{% endraw %}'

      - name: Install UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Restore dependency cache
        uses: actions/cache/restore@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            .venv
            ~/.cache/uv
          key: py-deps-{% raw %}${{  runner.os  }}{% endraw %}-{% raw %}${{  needs.setup-optimized.outputs.uv-hash  }}{% endraw %}
          restore-keys: |
            py-deps-{% raw %}${{  runner.os  }}{% endraw %}-

      - name: Install dependencies
        run: |
          uv sync --no-interaction --all-extras
{% if cookiecutter.use_mypy == "yes" %}
      - name: Type checking with MyPy
        run: |
          echo "üîç Running strict type checking..."
          uv run mypy src --config-file=pyproject.toml --cache-dir={% raw %}${{  env.MYPY_CACHE_DIR  }}{% endraw %}
{% endif %}
{% if cookiecutter.use_ruff == "yes" %}
      - name: Code formatting validation
        run: |
          echo "üßπ Validating code formatting..."
          uv run ruff format --check

      - name: Linting with enhanced rules
        run: |
          echo "üîß Running enhanced linting..."
          uv run ruff check . --config=pyproject.toml

      - name: Type hint syntax validation
        run: |
          echo "üîç Checking for | union syntax with future annotations..."
          uv run python scripts/check_type_hints.py --src-dir=src
{% endif %}

  # Success validation
  ci-success:
    name: CI Success Gate
    runs-on: ubuntu-latest
    needs: [setup-optimized, test, quality-checks]
    if: always()
    steps:
      - name: Validate CI Results
        run: |
          if [[ "{% raw %}${{  needs.setup-optimized.result  }}{% endraw %}" == "success" && \
                "{% raw %}${{  needs.test.result  }}{% endraw %}" == "success" && \
                "{% raw %}${{  needs.quality-checks.result  }}{% endraw %}" == "success" ]]; then
            echo "‚úÖ CI Pipeline - All Checks Passed"
            echo "üéØ Code quality validated"
            {% if cookiecutter.include_security_scanning == "yes" %}echo "üîí Security scans and quality checks completed"{% endif %}
            echo "‚úÖ Ready for deployment"
          else
            echo "‚ùå CI Pipeline Failed"
            echo "setup-optimized: {% raw %}${{  needs.setup-optimized.result  }}{% endraw %}"
            echo "test: {% raw %}${{  needs.test.result  }}{% endraw %}"
            echo "quality-checks: {% raw %}${{  needs.quality-checks.result  }}{% endraw %}"
            exit 1
          fi

  # Required status check for branch protection
  ci-gate:
    name: CI Gate
    runs-on: ubuntu-latest
    needs: [setup-optimized, test, quality-checks]
    if: always()
    steps:
      - name: CI Gate
        run: |
          if [[ "{% raw %}${{  needs.setup-optimized.result  }}{% endraw %}" == "success" && \
                "{% raw %}${{  needs.test.result  }}{% endraw %}" == "success" && \
                "{% raw %}${{  needs.quality-checks.result  }}{% endraw %}" == "success" ]]; then
            echo "‚úÖ CI Gate - Production Ready"
            echo "‚úÖ Code quality standards met"
            echo "‚ö° Performance validated"
          else
            echo "‚ùå CI Gate - Quality Standards Not Met"
            echo "üö´ Cannot proceed to production deployment"
            exit 1
          fi
