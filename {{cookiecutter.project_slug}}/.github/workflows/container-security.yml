# Container Security Scanning for {{ cookiecutter.project_name }}
# Scans Docker images for vulnerabilities using Trivy and lints Dockerfile with Hadolint.
#
# This is a thin caller to the org-level reusable workflow.
{%- if cookiecutter.include_github_actions == "yes" and cookiecutter.include_docker == "yes" %}
name: Container Security

on:
  push:
    branches: [main, master]
    paths:
      - 'Dockerfile'
      - 'docker-compose*.yml'
      - '.dockerignore'
      - 'pyproject.toml'
      - 'uv.lock'
  pull_request:
    branches: [main, master, develop]
    paths:
      - 'Dockerfile'
      - 'docker-compose*.yml'
      - '.dockerignore'
      - 'pyproject.toml'
      - 'uv.lock'
  schedule:
    # Weekly scan on Wednesdays at 7 AM UTC
    - cron: '0 7 * * 3'
  workflow_dispatch:

# Cancel in-progress runs for same PR/branch
concurrency:
  group: {% raw %}container-security-${{ github.event.pull_request.number || github.ref }}{% endraw %}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write
  packages: read

jobs:
  container-security:
    name: Container Security Scan
    uses: {{ cookiecutter.github_org_or_user }}/.github/.github/workflows/python-container-security.yml@main
    with:
      dockerfile-path: 'Dockerfile'
      build-context: '.'
      image-tag: '{{ cookiecutter.project_slug }}:scan'
      build-image: true
      severity-threshold: 'CRITICAL,HIGH'
      fail-on-vulnerabilities: true
      run-hadolint: true
      hadolint-failure-threshold: 'warning'
      generate-sbom: true
      upload-sarif: true
      artifact-retention-days: 90
    secrets: inherit
{%- elif cookiecutter.include_github_actions == "yes" %}
# Container security scanning is disabled because Docker is not enabled.
# To enable, set include_docker to "yes" in cookiecutter.json
{%- else %}
# GitHub Actions disabled for this project
# Enable include_github_actions and include_docker to use container security scanning
{%- endif %}
