# Container Security Scanning with Trivy
# Scans Docker images for vulnerabilities, misconfigurations, and secrets.
#
# Features:
#   - Vulnerability scanning (CVEs)
#   - Misconfiguration detection
#   - Secret scanning in container layers
#   - SARIF output for GitHub Security tab
#   - SBOM generation for containers
{%- if cookiecutter.include_github_actions == "yes" and cookiecutter.include_docker == "yes" %}
name: Container Security

on:
  push:
    branches: [main, master]
    paths:
      - 'Dockerfile'
      - 'docker-compose*.yml'
      - '.dockerignore'
      - 'pyproject.toml'
      - 'uv.lock'
  pull_request:
    branches: [main, master, develop]
    paths:
      - 'Dockerfile'
      - 'docker-compose*.yml'
      - '.dockerignore'
      - 'pyproject.toml'
      - 'uv.lock'
  schedule:
    # Weekly scan on Wednesdays at 7 AM UTC
    - cron: '0 7 * * 3'
  workflow_dispatch:

# Cancel in-progress runs for same PR/branch
concurrency:
  group: {% raw %}container-security-${{ github.event.pull_request.number || github.ref }}{% endraw %}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write
  packages: read

env:
  IMAGE_NAME: {{ cookiecutter.project_slug }}
  REGISTRY: ghcr.io

jobs:
  # ==========================================================================
  # Build and Scan Container Image
  # ==========================================================================
  trivy-scan:
    name: Trivy Container Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image for scanning
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          tags: {% raw %}${{ env.IMAGE_NAME }}:scan{% endraw %}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: {% raw %}${{ env.IMAGE_NAME }}:scan{% endraw %}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          vuln-type: 'os,library'
          scanners: 'vuln,secret,misconfig'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Trivy for detailed report
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: {% raw %}${{ env.IMAGE_NAME }}:scan{% endraw %}
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'
          vuln-type: 'os,library'
          scanners: 'vuln'

      - name: Check for critical vulnerabilities
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: {% raw %}${{ env.IMAGE_NAME }}:scan{% endraw %}
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL'
          vuln-type: 'os,library'
          scanners: 'vuln'

  # ==========================================================================
  # Dockerfile Linting
  # ==========================================================================
  dockerfile-lint:
    name: Dockerfile Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Run Hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          failure-threshold: warning
          format: sarif
          output-file: hadolint-results.sarif

      - name: Upload Hadolint results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: hadolint-results.sarif

  # ==========================================================================
  # Container SBOM Generation
  # ==========================================================================
  container-sbom:
    name: Container SBOM
    runs-on: ubuntu-latest
    needs: [trivy-scan]
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          tags: {% raw %}${{ env.IMAGE_NAME }}:sbom{% endraw %}

      - name: Generate SBOM with Trivy
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: {% raw %}${{ env.IMAGE_NAME }}:sbom{% endraw %}
          format: 'cyclonedx'
          output: 'container-sbom.json'

      - name: Upload Container SBOM
        uses: actions/upload-artifact@v4
        with:
          name: container-sbom
          path: container-sbom.json
          retention-days: 90

  # ==========================================================================
  # Security Summary
  # ==========================================================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [trivy-scan, dockerfile-lint, container-sbom]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## Container Security Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          {% raw %}
          if [ "${{ needs.trivy-scan.result }}" == "success" ]; then
            echo "✅ **Trivy Scan**: No critical vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Trivy Scan**: ${{ needs.trivy-scan.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.dockerfile-lint.result }}" == "success" ]; then
            echo "✅ **Dockerfile Lint**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ **Dockerfile Lint**: ${{ needs.dockerfile-lint.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.container-sbom.result }}" == "success" ]; then
            echo "✅ **Container SBOM**: Generated" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ **Container SBOM**: ${{ needs.container-sbom.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.trivy-scan.result }}" == "failure" ]; then
            echo "❌ Critical container vulnerabilities detected. Review and remediate before deployment." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          {% endraw %}

          echo "✅ Container security checks passed!" >> $GITHUB_STEP_SUMMARY
{%- elif cookiecutter.include_github_actions == "yes" %}
# Container security scanning is disabled because Docker is not enabled.
# To enable, set include_docker to "yes" in cookiecutter.json
{%- else %}
# GitHub Actions disabled for this project
# Enable include_github_actions and include_docker to use container security scanning
{%- endif %}
