name: ClusterFuzzLite

# Continuous fuzzing for security vulnerability detection
# See: https://google.github.io/clusterfuzzlite/

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
  schedule:
    # Run weekly on Wednesdays at 3:00 AM UTC
    - cron: "0 3 * * 3"

permissions: read-all

jobs:
  fuzzing:
    name: Build & Run Fuzzers
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      security-events: write  # Required for SARIF upload
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Build Fuzzers
        id: build
        # Note: ClusterFuzzLite actions use @v1, cannot pin to SHA (maintained by Google)
        uses: google/clusterfuzzlite/actions/build_fuzzers@v1
        with:
          language: python
          dry-run: false

      - name: Run Fuzzers
        # Note: ClusterFuzzLite actions use @v1, cannot pin to SHA (maintained by Google)
        uses: google/clusterfuzzlite/actions/run_fuzzers@v1
        if: steps.build.outcome == 'success'
        with:
          fuzz-seconds: 600  # 10 minutes of fuzzing
          language: python
          output-sarif: true
          sanitizer: address

      - name: Upload Crash Artifacts
        if: failure() && steps.build.outcome == 'success'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: fuzzing-crashes
          path: out/artifacts
          retention-days: 7

      - name: Upload SARIF Report
        if: always() && steps.build.outcome == 'success'
        uses: github/codeql-action/upload-sarif@48ab28a6f5dbc2a99bf1e0131198dd8f1df78169 # v3.27.5
        with:
          sarif_file: sarif/cifuzz.sarif
        continue-on-error: true

      - name: Fuzzing Summary
        if: always()
        run: |
          echo "## ðŸ” ClusterFuzzLite Fuzzing Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Status**: ${{ steps.build.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.build.outcome }}" == "success" ]]; then
            echo "âœ… Fuzzers built and executed for 600 seconds" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Fuzzing Targets**:" >> $GITHUB_STEP_SUMMARY
            echo "- API endpoints and input validation" >> $GITHUB_STEP_SUMMARY
            echo "- File parsers and data processors" >> $GITHUB_STEP_SUMMARY
            echo "- Security-critical code paths" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ” Security vulnerabilities detection active" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  Fuzzer build failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Troubleshooting**:" >> $GITHUB_STEP_SUMMARY
            echo "1. Ensure Clang and LLVM are installed" >> $GITHUB_STEP_SUMMARY
            echo "2. Verify fuzzing harnesses in /fuzz directory" >> $GITHUB_STEP_SUMMARY
            echo "3. Check Atheris installation succeeded" >> $GITHUB_STEP_SUMMARY
          fi
