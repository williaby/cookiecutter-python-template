name: SBOM & Supply Chain Security

on:
  pull_request:
    paths:
      - "pyproject.toml"
      - "poetry.lock"
      - ".github/workflows/sbom.yml"
  push:
    branches: [main, develop]
    paths:
      - "pyproject.toml"
      - "poetry.lock"
  schedule:
    # Weekly scan every Monday at 8:00 AM UTC
    - cron: "0 8 * * 1"
  workflow_dispatch:  # Allow manual triggers

permissions: read-all

jobs:
  generate-sbom:
    name: Generate SBOMs
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: "3.12"

      - name: Install Poetry
        uses: snok/install-poetry@76e04a911780d5b312d89783f7b1cd627778900a # v1.4.1
        with:
          version: 2.1.2
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Install cyclonedx-bom
        run: pip install cyclonedx-bom==4.6.1

      - name: Generate runtime SBOM (production dependencies)
        run: |
          cyclonedx-py poetry \
            --of json \
            -o sbom-runtime.json \
            --no-dev

      - name: Generate development SBOM (dev dependencies only)
        run: |
          cyclonedx-py poetry \
            --of json \
            -o sbom-dev.json \
            --only dev

      - name: Generate complete SBOM (all dependencies)
        run: |
          cyclonedx-py poetry \
            --of json \
            -o sbom-complete.json

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: sboms
          path: sbom-*.json
          retention-days: 90

  scan-runtime:
    name: Scan Runtime Dependencies
    needs: generate-sbom
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write  # Required for SARIF upload
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
        with:
          egress-policy: audit

      - name: Download SBOM artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: sboms

      - name: Trivy SBOM scan (runtime)
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.33.1
        with:
          scan-type: sbom
          scan-ref: sbom-runtime.json
          format: table
          severity: CRITICAL,HIGH
          exit-code: 1  # Fail on CRITICAL/HIGH vulnerabilities

      - name: Trivy SBOM scan (runtime - detailed report)
        if: always()
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.33.1
        with:
          scan-type: sbom
          scan-ref: sbom-runtime.json
          format: sarif
          output: trivy-runtime-results.sarif

      - name: Upload Trivy results to GitHub Security tab
        if: always()
        uses: github/codeql-action/upload-sarif@48ab28a6f5dbc2a99bf1e0131198dd8f1df78169 # v3.27.5
        with:
          sarif_file: trivy-runtime-results.sarif
          category: trivy-runtime-deps

  scan-dev:
    name: Scan Development Dependencies
    needs: generate-sbom
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write  # Required for SARIF upload
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
        with:
          egress-policy: audit

      - name: Download SBOM artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: sboms

      - name: Trivy SBOM scan (dev)
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.33.1
        with:
          scan-type: sbom
          scan-ref: sbom-dev.json
          format: table
          severity: CRITICAL,HIGH
          exit-code: 0  # Don't fail on dev dependency vulnerabilities (informational only)

      - name: Trivy SBOM scan (dev - detailed report)
        if: always()
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.33.1
        with:
          scan-type: sbom
          scan-ref: sbom-dev.json
          format: sarif
          output: trivy-dev-results.sarif

      - name: Upload Trivy results to GitHub Security tab
        if: always()
        uses: github/codeql-action/upload-sarif@48ab28a6f5dbc2a99bf1e0131198dd8f1df78169 # v3.27.5
        with:
          sarif_file: trivy-dev-results.sarif
          category: trivy-dev-deps

  scan-complete:
    name: Scan Complete SBOM
    needs: generate-sbom
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
        with:
          egress-policy: audit

      - name: Download SBOM artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: sboms

      - name: Trivy SBOM scan (complete)
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.33.1
        with:
          scan-type: sbom
          scan-ref: sbom-complete.json
          format: json
          output: trivy-complete-results.json

      - name: Upload complete scan results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: trivy-complete-scan
          path: trivy-complete-results.json
          retention-days: 90

  license-compliance:
    name: License Compliance Check
    needs: generate-sbom
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
        with:
          egress-policy: audit

      - name: Download SBOM artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: sboms

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: "3.12"

      - name: Check licenses in runtime SBOM
        run: |
          echo "Checking runtime dependency licenses..."
          python -c "
          import json
          with open('sbom-runtime.json') as f:
              sbom = json.load(f)

          # Use precise SPDX license identifiers (exact match)
          forbidden_licenses = [
              'GPL-2.0-only', 'GPL-2.0-or-later',
              'GPL-3.0-only', 'GPL-3.0-or-later',
              'AGPL-3.0-only', 'AGPL-3.0-or-later'
          ]
          issues = []

          for component in sbom.get('components', []):
              licenses = component.get('licenses', [])
              for lic in licenses:
                  lic_id = lic.get('license', {}).get('id', '')
                  if lic_id in forbidden_licenses:
                      issues.append(f\"{component['name']}: {lic_id}\")

          if issues:
              print('WARNING: Found potentially incompatible licenses:')
              for issue in issues:
                  print(f'  - {issue}')
              # Don't fail, just warn
          else:
              print('âœ… All licenses compatible')
          "
