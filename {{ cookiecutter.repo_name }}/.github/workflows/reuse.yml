name: REUSE Compliance

# REUSE compliance ensures all files have proper license and copyright information
# See: https://reuse.software/

on:
  pull_request:
    paths:
      - "**/*"
      - "REUSE.toml"
      - "LICENSES/**"
      - ".github/workflows/reuse.yml"
  push:
    branches: [main, develop]
  workflow_dispatch:

permissions: read-all

jobs:
  reuse:
    name: Check REUSE Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: REUSE Compliance Check
        uses: fsfe/reuse-action@3ae3c6bdf1257ab19397fab11fd3312144692083 # v4.0.0

      - name: Generate REUSE SPDX
        if: success()
        run: |
          docker run --rm --volume $(pwd):/data fsfe/reuse:latest spdx --output /data/reuse-spdx.json

      - name: Upload REUSE SPDX
        if: success()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: reuse-spdx
          path: reuse-spdx.json
          retention-days: 90

  validate-licenses:
    name: Validate License Files
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Check MIT license (primary)
        run: |
          if [ ! -f "LICENSES/MIT.txt" ]; then
            echo "Error: MIT.txt missing from LICENSES/"
            echo "Download from: https://spdx.org/licenses/MIT.txt"
            exit 1
          fi
          echo "✅ MIT license found"

      - name: Check CC0-1.0 license (for public domain)
        run: |
          if [ ! -f "LICENSES/CC0-1.0.txt" ]; then
            echo "Warning: CC0-1.0.txt missing from LICENSES/"
            echo "Recommended for configuration files and build scripts"
            echo "Download from: https://spdx.org/licenses/CC0-1.0.txt"
          else
            echo "✅ CC0-1.0 license found"
          fi
        continue-on-error: true

      - name: Verify REUSE.toml exists
        run: |
          if [ ! -f "REUSE.toml" ]; then
            echo "Error: REUSE.toml missing from repository root"
            echo "Create with: reuse init"
            exit 1
          fi
          echo "✅ REUSE.toml configuration found"

      - name: REUSE compliance summary
        if: always()
        run: |
          echo "## REUSE Compliance Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "REUSE ensures:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ All files have license and copyright information" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ License texts are in LICENSES/ directory" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ SPDX identifiers are used consistently" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Learn more: https://reuse.software/" >> $GITHUB_STEP_SUMMARY
